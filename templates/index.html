{% extends 'base.html' %}

{% block title %}Inicio | Dashboard Squid{% endblock %}

{% block content %}

    <div id="datos-conexiones" class="max-w-7xl mx-auto sm:px-6 lg:px-8">
        {% include 'partials/conexiones.html' %}
    </div>
    
    <script>
        // --- NUEVO: Variable para guardar el estado de la vista ---
        // Se inicializa en 'true' porque la vista por defecto es detallada.
        let isDetailedView = true;

        // --- NUEVO: Función central para aplicar el estado a la vista ---
        // Esta función lee la variable 'isDetailedView' y actualiza el DOM.
        function applyViewState() {
            const contents = document.querySelectorAll('[data-accordion-content]');
            const icons = document.querySelectorAll('.user-accordion .fa-chevron-down');
            const toggleAllButton = document.getElementById('toggle-all-button');

            if (contents.length === 0 || !toggleAllButton) return;

            if (isDetailedView) {
                // Aplica la VISTA DETALLADA
                contents.forEach(content => content.classList.remove('hidden'));
                icons.forEach(icon => icon.classList.add('rotate-180'));
                toggleAllButton.textContent = 'Ver Resumen';
            } else {
                // Aplica la VISTA DE RESUMEN
                contents.forEach(content => content.classList.add('hidden'));
                icons.forEach(icon => icon.classList.remove('rotate-180'));
                toggleAllButton.textContent = 'Ver Detalles';
            }
        }

        // Función para configurar el botón. Ahora solo cambia el estado y llama a applyViewState.
        function setupSummaryButton() {
            const toggleAllButton = document.getElementById('toggle-all-button');
            if (!toggleAllButton) return;

            // Se usa cloneNode y replaceWith para evitar añadir múltiples listeners en cada refresco.
            const newButton = toggleAllButton.cloneNode(true);
            toggleAllButton.parentNode.replaceChild(newButton, toggleAllButton);

            newButton.addEventListener('click', () => {
                isDetailedView = !isDetailedView; // Cambia el estado guardado
                applyViewState(); // Aplica el nuevo estado a la vista
            });
        }

        async function refrescarConexiones() {
            try {
                const response = await fetch('/actualizar-conexiones');
                if (!response.ok) throw new Error("Respuesta no OK");
                
                const html = await response.text();
                const container = document.getElementById('datos-conexiones');
                container.innerHTML = html;

                // Vuelve a configurar el botón para el nuevo contenido
                setupSummaryButton();

                // --- ¡CAMBIO CLAVE! ---
                // Después de refrescar, aplica el último estado que guardamos.
                applyViewState();

            } catch (error) {
                console.error("Error al actualizar conexiones:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Configura el botón de resumen cuando la página carga por primera vez
            setupSummaryButton();

            // Configura el refresco para que se ejecute cada 60 segundos
            setInterval(refrescarConexiones, 60000);
        });
    </script>
{% endblock %}