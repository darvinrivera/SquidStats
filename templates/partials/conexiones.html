{% set valid_users = {} %}
{% for user, user_data in grouped_connections.items() %}
    {% if user and user != "-" and user != "Anónimo" %}
        {% set _ = valid_users.update({user: user_data}) %}
    {% endif %}
{% endfor %}

<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">

    {# Tarjetas de estadísticas #}
    <div class="flex justify-center mb-8">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 w-full max-w-6xl">
            
            {# --- MODIFICADO: Tarjeta de información del Servidor Squid --- #}
            <div class="bg-white p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg hover:-translate-y-0.5">
                <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center mr-4 flex-shrink-0">
                    <i class="fas fa-server text-indigo-500 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Servidor Squid (v{{ squid_version }})</p>
                    <p class="text-2xl font-bold">{{ squid_ip }}</p>
                </div>
            </div>
            
            {# --- MODIFICADO: Tarjeta de estado del Proxy Padre --- #}
            {% if parent_proxy_ip %}
            {# Estado Con Padre #}
            <div class="bg-white p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg hover:-translate-y-0.5">
                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mr-4 flex-shrink-0">
                    <i class="fas fa-sitemap text-green-500 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Proxy Padre Activo</p>
                    <p class="text-2xl font-bold">{{ parent_proxy_ip }}</p>
                </div>
            </div>
            {% else %}
            {# Estado Sin Padre #}
            <div class="bg-white p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg hover:-translate-y-0.5">
                <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center mr-4 flex-shrink-0">
                    <i class="fas fa-plug-circle-xmark text-gray-500 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Sin Proxy Padre</p>
                    <p class="text-2xl font-bold">Conexión Directa</p>
                </div>
            </div>
            {% endif %}

            {# Tarjeta de Usuarios Activos #}
            <div class="bg-white p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg hover:-translate-y-0.5">
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mr-4 flex-shrink-0">
                    <i class="fas fa-users text-blue-500 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Usuarios Activos</p>
                    <p class="text-2xl font-bold">{{ valid_users|length }}</p>
                </div>
            </div>

            {# Tarjeta de Conexiones Totales #}
            <div class="bg-white p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg hover:-translate-y-0.5">
                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mr-4 flex-shrink-0">
                    <i class="fas fa-exchange-alt text-green-500 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Conexiones Totales</p>
                    <p class="text-2xl font-bold">
                        {% set total = namespace(value=0) %}
                        {% for user_data in valid_users.values() %}
                            {% set total.value = total.value + user_data.connections|length %}
                        {% endfor %}
                        {{ total.value }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    {% if valid_users|length > 0 %}
    <div class="flex justify-end mb-4">
        <button id="toggle-all-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
            Ver Resumen
        </button>
    </div>
    {% endif %}

    <div id="user-accordion-group">
    {% for user, user_data in valid_users.items() %}
    
    {% set connections = user_data.connections %}
    {% set client_ip = user_data.client_ip %}

    <div class="user-accordion bg-white rounded-lg shadow-md mb-3 overflow-hidden">
        <div class="w-full text-left p-4 border-b bg-white">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                <div class="flex items-center mb-3 sm:mb-0">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0">
                        <i class="fas fa-user text-blue-600"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">{{ user }}</h2>
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                    
                    <div class="flex items-center text-sm text-gray-600" title="IP del Cliente">
                        <i class="fas fa-network-wired mr-1.5 text-gray-500"></i>
                        <span>{{ client_ip }}</span>
                    </div>

                    <div class="flex items-center text-sm text-gray-600" title="Conexiones totales de este usuario">
                        <i class="fas fa-link mr-1.5 text-blue-500"></i>
                        <span>{{ connections|length }} conexiones</span>
                    </div>
                    
                    {% set total_data = namespace(value=0) %}
                    {% set total_requests = namespace(value=0) %}
                    {% for connection in connections %}
                        {% if connection.fd_total != "N/A" %}
                            {% set total_data.value = total_data.value + connection.fd_total %}
                        {% endif %}
                        {% set total_requests.value = total_requests.value + connection.nrequests %}
                    {% endfor %}
                    
                    <div class="flex items-center text-sm text-gray-600" title="Total de datos transferidos">
                        <i class="fas fa-database mr-1.5 text-green-500"></i>
                        <span>{{ (total_data.value / 1024 / 1024)|round(2) }} MB</span>
                    </div>
                    
                    <div class="flex items-center text-sm text-gray-600" title="Total de solicitudes">
                        <i class="fas fa-bullhorn mr-1.5 text-purple-500"></i>
                        <span>{{ total_requests.value }} solicitudes</span>
                    </div>
                    <div class="w-6 text-center">
                        <i class="fas fa-chevron-down transition-transform duration-300 rotate-180"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div data-accordion-content>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Duración</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Método</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">URL</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Datos</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Delay Pool</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Solicitudes</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Dir. Remota</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for connection in connections %}
                        <tr class="transition-colors duration-200 ease-in-out hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                {% set seconds = connection.elapsed_time|float %}
                                {% if seconds >= 3600 %}{{ "%.2f"|format(seconds/3600) }} h
                                {% elif seconds >= 60 %}{{ "%.2f"|format(seconds/60) }} min
                                {% else %}{{ "%.2f"|format(seconds) }} seg{% endif %}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                {% set method = connection.logType|lower %}
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ... {% if method == 'connect' or method == 'tcp_tunnel' %}bg-green-100 text-green-800 ... {% endif %}">
                                    {{ connection.logType }}
                                </span>
                            </td>
                            <td class="px-4 py-3 max-w-xs">
                                <div class="truncate text-sm transition-colors duration-200 hover:text-blue-600" title="{{ connection.uri }}">
                                    {{ connection.uri }}
                                </div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm">
                                {% if connection.fd_total != "N/A" %}{{ (connection.fd_total / 1024 / 1024)|round(2) }} MB
                                {% else %}N/A{% endif %}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                {% if connection.delay_pool != "N/A" %}
                                {% set pool = connection.delay_pool|string %}
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ... {% if pool == '0' %}bg-sky-100 text-sky-800 ... {% endif %}">
                                    Pool {{ connection.delay_pool }}
                                </span>
                                {% else %}<span class="text-sm text-gray-500">N/A</span>{% endif %}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">{{ connection.nrequests }}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-mono ... hover:text-blue-600">{{ connection.proxy_local_ip }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
    </div>
</div>